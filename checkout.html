<!DOCTYPE html><body style="background-color:powderblue;"></body>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Vaishnavi Furniture</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4 text-center">Checkout</h2>
    <div class="mb-4">
  <h4 class="mb-3">Your Items</h4>
  <div id="checkout-cart" class="border rounded p-3 bg-light mb-3"></div>
  <h5>Total: â‚¹<span id="checkout-total">0</span></h5>
</div>


    <!-- ðŸ› Cart Summary -->
    <form id="checkout-form" class="needs-validation">
  <div class="mb-3">
    <label for="name" class="form-label">Full Name</label>
    <input type="text" class="form-control" id="name" required>
  </div>

  <div class="mb-3">
    <label for="phone" class="form-label">Phone Number</label>
    <input type="tel" class="form-control" id="phone" required>
  </div>

  <div class="mb-3">
    <label for="address" class="form-label">Address</label>
    <textarea class="form-control" id="address" rows="3" required></textarea>
  </div>

  <button type="submit" class="btn btn-success w-100">Place Order via WhatsApp</button>
</form>

<!--checkout  -->
  <script type="module">
  import { db } from "./assets/js/firebase.js";
  import {
    collection,
    getDocs,
    addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const cartKey = "vaishnavi_cart";
  const productCollection = collection(db, "products");
  const orderCollection = collection(db, "orders");

  function getCart() {
    return JSON.parse(localStorage.getItem(cartKey)) || [];
  }

  async function fetchProducts() {
    const snapshot = await getDocs(productCollection);
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
  }

  async function renderCheckoutCart() {
    const cart = getCart();
    const products = await fetchProducts();
    const container = document.getElementById("checkout-cart");
    let total = 0;
    container.innerHTML = "";

    if (!cart.length) {
      container.innerHTML = "<p class='text-muted'>Your cart is empty.</p>";
      document.getElementById("checkout-total").innerText = "0";
      return 0;
    }

    cart.forEach(item => {
      const product = products.find(p => p.id === item.productId);
      if (!product) return;

      const lineTotal = item.qty * product.price;
      total += lineTotal;

      const row = document.createElement("div");
      row.className = "d-flex justify-content-between mb-2";
      row.innerHTML = `<span>${product.name} Ã— ${item.qty}</span><span>â‚¹${lineTotal}</span>`;
      container.appendChild(row);
    });

    document.getElementById("checkout-total").innerText = total.toLocaleString();
    return total;
  }

  const total = await renderCheckoutCart();

  document.getElementById("checkout-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const name = this.name.value.trim();
    const phone = this.phone.value.trim();
    const address = this.address.value.trim();
    const cart = getCart();
    const products = await fetchProducts();

    if (!name || !phone || !address || cart.length === 0) {
      alert("Please complete all fields and add something to the cart.");
      return;
    }

    const total = await renderCheckoutCart();

    const order = {
      customer: { name, phone, address },
      items: cart,
      total,
      orderStatus: "new",
      paymentStatus: "cod",
      createdAt: new Date().toISOString()
    };

    try {
      await addDoc(orderCollection, order);
      console.log("âœ… Order saved to Firestore");
    } catch (err) {
      console.error("âŒ Firestore error:", err);
    }

    const waMsg = `
ðŸ›’ New Order from Vaishnavi Furniture

ðŸ‘¤ Name: ${name}
ðŸ“ž Phone: ${phone}
ðŸ  Address: ${address}

ðŸ§¾ Items:
${cart.map(item => {
      const p = products.find(p => p.id === item.productId);
      return p ? `â€¢ ${p.name} x ${item.qty}` : '';
    }).join("\n")}

ðŸ’° Total: â‚¹${total.toLocaleString()}
    `.trim();

   const waLink = `https://wa.me/917972803288?text=${encodeURIComponent(waMsg)}`;

    window.open(waLink, "_blank");

    alert("âœ… Order placed! Redirecting...");
    localStorage.removeItem(cartKey);
    window.location.href = "index.html";
  });
</script>



</body>
</html>
